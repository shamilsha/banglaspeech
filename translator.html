<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Voice Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a clear, modern font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container-card {
            background-color: white;
            padding: 3rem 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            border-top: 5px solid #06B6D4; /* Cyan border for a modern touch */
        }
        .mic-button {
            transition: all 0.2s ease-in-out;
        }
        .mic-button:hover {
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        .mic-button.recording {
            animation: pulse-red 1.5s infinite;
            background-color: #EF4444; /* Red while recording */
            color: white;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* Style for the Speak button */
        .speak-button {
            transition: background-color 0.2s;
        }
        .speak-button:hover {
            background-color: #0c8c9e;
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: 'â–¼';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #4a5568;
        }
        #target-language-select {
            appearance: none;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body>

<div class="container-card">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Universal Voice Translator</h1>
    <p class="text-center text-gray-500 mb-6">Speak in English, get instant translation and audio.</p>

    <!-- Language Selector -->
    <div class="flex justify-center mb-8">
        <div class="select-wrapper w-full max-w-sm">
            <select id="target-language-select"
                    class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="fr-FR" data-name="French">Translate to French</option>
                <option value="es-ES" data-name="Spanish">Translate to Spanish</option>
                <option value="it-IT" data-name="Italian">Translate to Italian</option>
            </select>
        </div>
    </div>
    
    <!-- Source Language: English (Speech-to-Text) -->
    <div class="mb-8 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
            Source Text (English)
            <span id="listening-status" class="ml-4 text-sm font-medium text-red-500 hidden">... Listening</span>
        </h2>
        <textarea id="source-text"
                  rows="4"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 resize-none text-gray-700"
                  placeholder="Speak into the microphone to see the English text appear here..."
                  readonly></textarea>
        <p id="error-message" class="text-red-500 mt-2 text-sm hidden">Microphone access denied or not supported.</p>
    </div>

    <!-- Translator Controls -->
    <div class="flex flex-col items-center justify-center space-y-4 mb-8">
        <button id="mic-btn"
                class="mic-button bg-cyan-500 text-white p-5 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-300"
                aria-label="Start Recording"
                disabled>
            <!-- Microphone icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>
        <button id="speak-btn"
                class="speak-button bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50"
                aria-label="Speak Translation"
                disabled>
            Speak French
        </button>
    </div>

    <!-- Target Language: Translated Text -->
    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h2 id="translated-title" class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
            Translated Text (French)
        </h2>
        <textarea id="translated-text"
                  rows="4"
                  class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none text-gray-800 font-medium"
                  placeholder="The French translation will appear here..."
                  readonly></textarea>
    </div>

</div>

<script>
    // --- 1. Tooling and Constants Setup ---
    const sourceTextarea = document.getElementById('source-text');
    const translatedTextarea = document.getElementById('translated-text');
    const micBtn = document.getElementById('mic-btn');
    const speakBtn = document.getElementById('speak-btn');
    const listeningStatus = document.getElementById('listening-status');
    const errorMessage = document.getElementById('error-message');
    const langSelect = document.getElementById('target-language-select');
    const translatedTitle = document.getElementById('translated-title');

    // Language configuration
    const SOURCE_LANGUAGE_CODE = 'en-US'; // English (United States) for speech recognition
    let TARGET_LANGUAGE_CODE = langSelect.value; // Starts as fr-FR

    let recognition = null;
    let isRecording = false;

    // --- Dynamic UI Update Function ---
    const updateTargetLanguageUI = () => {
        TARGET_LANGUAGE_CODE = langSelect.value;
        const selectedOption = langSelect.options[langSelect.selectedIndex];
        const langName = selectedOption.getAttribute('data-name');
        
        translatedTitle.textContent = `Translated Text (${langName})`;
        speakBtn.textContent = `Speak ${langName}`;
        translatedTextarea.placeholder = `The ${langName} translation will appear here...`;
        
        // Clear previous translation when language changes
        translatedTextarea.value = '';
        speakBtn.disabled = true;
    };


    // --- 2. Initialize Speech Recognition ---
    const initializeRecognition = () => {
        // Check for browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            errorMessage.textContent = "Speech Recognition is not supported in this browser. Please use Chrome or Edge.";
            errorMessage.classList.remove('hidden');
            micBtn.disabled = true;
            return;
        }

        // Initialize the recognition object
        recognition = new SpeechRecognition();
        recognition.continuous = false; // Stop after a single phrase
        recognition.interimResults = false; // Only return final results
        recognition.lang = SOURCE_LANGUAGE_CODE;

        // Recognition Event Handlers
        recognition.onstart = () => {
            isRecording = true;
            micBtn.classList.add('recording');
            listeningStatus.classList.remove('hidden');
            sourceTextarea.value = ''; // Clear previous text
            translatedTextarea.value = '';
            speakBtn.disabled = true;
        };

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            sourceTextarea.value = transcript;
            
            if (transcript) {
                // Once we have the source text, automatically call the translation function
                translateAndDisplay(transcript);
            }
        };

        recognition.onend = () => {
            isRecording = false;
            micBtn.classList.remove('recording');
            listeningStatus.classList.add('hidden');
        };

        recognition.onerror = (event) => {
            console.error('Speech Recognition Error:', event.error);
            errorMessage.textContent = `Error: ${event.error}. Please check your microphone permissions.`;
            errorMessage.classList.remove('hidden');
            micBtn.classList.remove('recording');
            listeningStatus.classList.add('hidden');
            isRecording = false;
        };
        
        // Everything is ready, enable the button
        micBtn.disabled = false;
    };

    // --- 3. Translation Function (Uses Gemini API for simulation) ---
    const translateAndDisplay = async (text) => {
        const langName = langSelect.options[langSelect.selectedIndex].getAttribute('data-name');
        translatedTextarea.placeholder = `Translating to ${langName}...`;
        
        // The TARGET_LANGUAGE_CODE is read dynamically here
        const targetCode = TARGET_LANGUAGE_CODE; 

        // System prompt uses the dynamic language name
        const systemPrompt = `You are a highly accurate, professional language translator. Your only job is to translate the provided English text into a grammatically correct, natural-sounding ${langName} translation. Respond with ONLY the translated ${langName} text, nothing else.`;
        const userQuery = `Translate the following English phrase to ${langName}: "${text}"`;
        
        // API Configuration
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            config: {
                temperature: 0.1 
            }
        };
        
        let translatedText = "Translation failed or is unavailable.";
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                translatedText = candidate.content.parts[0].text.trim(); 
            }
        } catch (error) {
            console.error("Translation API Error:", error);
            translatedText = "Could not reach translation service.";
        }
        
        translatedTextarea.value = translatedText;
        translatedTextarea.placeholder = `The ${langName} translation will appear here...`;
        
        // Enable speech button once translation is complete
        speakBtn.disabled = translatedText.includes("failed") || translatedText.includes("Could not reach");
    };

    // --- 4. Text-to-Speech (Speaking the Translation) ---
    const speakTranslation = () => {
        const textToSpeak = translatedTextarea.value;

        if (!textToSpeak) {
            alert('Please translate text first.');
            return;
        }

        if (!'speechSynthesis' in window) {
            errorMessage.textContent = "Text-to-Speech is not supported in this browser.";
            errorMessage.classList.remove('hidden');
            return;
        }
        
        // The utterance uses the dynamic language code
        const targetCode = TARGET_LANGUAGE_CODE; 
        
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        
        // Find a matching voice for the target language
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(voice => voice.lang === targetCode || voice.lang.startsWith(targetCode.substring(0, 2)));
        
        if (targetVoice) {
            utterance.voice = targetVoice;
        } else {
            // Fallback: Set language code even without a specific voice
            utterance.lang = targetCode; 
            console.warn(`Voice for ${targetCode} not found, using default voice with correct language setting.`);
        }
        
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        window.speechSynthesis.speak(utterance);
    };


    // --- 5. Event Listeners ---
    micBtn.addEventListener('click', () => {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    });

    speakBtn.addEventListener('click', speakTranslation);
    
    // Listen for changes on the language selector
    langSelect.addEventListener('change', updateTargetLanguageUI);

    // Initial check and setup on page load
    window.onload = () => {
        updateTargetLanguageUI(); // Set initial state (French)
        initializeRecognition();

        // Important: Load voices for TTS. It may be asynchronous.
        if ('speechSynthesis' in window) {
            if (window.speechSynthesis.getVoices().length === 0) {
                 window.speechSynthesis.onvoiceschanged = initializeRecognition;
            }
        }
    };

</script>
</body>
</html>
