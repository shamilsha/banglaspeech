<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Bidirectional Voice Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container-card {
            background-color: white;
            padding: 3rem 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            width: 100%;
            border-top: 5px solid #06B6D4;
        }
        .mic-button {
            transition: all 0.2s ease-in-out;
        }
        .mic-button:hover {
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        .mic-button.recording {
            animation: pulse-red 1.5s infinite;
            background-color: #EF4444;
            color: white;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .speak-button {
            transition: background-color 0.2s;
        }
        .speak-button:hover {
            background-color: #0c8c9e;
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: 'â–¼';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #4a5568;
        }
        #secondary-language-select {
            appearance: none;
            padding-right: 2.5rem;
        }

        /* Responsive layout for the panels */
        @media (min-width: 768px) {
            .panel-grid {
                grid-template-columns: 1fr 50px 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container-card">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Universal Voice Translator</h1>
    <p class="text-center text-gray-500 mb-6">Speak in either language and get instant two-way translation.</p>

    <!-- Global Language Selector -->
    <div class="flex flex-col md:flex-row justify-center items-center mb-8 space-y-3 md:space-y-0 md:space-x-4">
        <label for="secondary-language-select" class="text-gray-700 font-medium">Select Paired Language:</label>
        <div class="select-wrapper w-full max-w-xs">
            <select id="secondary-language-select"
                    class="w-full bg-white border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
                <option value="fr-FR" data-name="French">French</option>
                <option value="es-ES" data-name="Spanish">Spanish</option>
                <option value="it-IT" data-name="Italian">Italian</option>
            </select>
        </div>
    </div>
    
    <!-- Translation Panels and Controls -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 panel-grid">
        
        <!-- Panel A (Primary Language - English) -->
        <div id="panel-A" class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
            <h2 id="title-A" class="text-xl font-bold text-gray-700 mb-3">Language A (Source)</h2>
            <textarea id="text-A"
                      rows="6"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 resize-none text-gray-700 font-medium"
                      placeholder="Speak here, or type, to translate..."></textarea>
            
            <div class="flex justify-between items-center mt-3">
                <p id="status-A" class="text-sm font-medium text-red-500 hidden">... Listening</p>
                <button id="mic-btn-A"
                        class="mic-button bg-cyan-500 text-white p-3 rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-cyan-300"
                        aria-label="Start Recording Language A"
                        disabled>
                    <!-- Microphone icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </button>
            </div>
        </div>

        <!-- Swap Button (Middle) -->
        <div class="flex justify-center items-center py-4 md:py-0">
            <button id="swap-btn"
                    class="bg-gray-200 text-gray-700 p-4 rounded-full shadow-md hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-gray-300"
                    aria-label="Swap Source and Target Languages">
                <!-- Swap icon (left/right arrows) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-repeat"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
            </button>
        </div>

        <!-- Panel B (Secondary Language - Target) -->
        <div id="panel-B" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h2 id="title-B" class="text-xl font-bold text-gray-700 mb-3">Language B (Target)</h2>
            <textarea id="text-B"
                      rows="6"
                      class="w-full p-3 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none text-gray-800 font-medium"
                      placeholder="The translation will appear here..."
                      readonly></textarea>
            
            <div class="flex justify-between items-center mt-3">
                <span class="text-sm font-medium text-transparent">Placeholder</span> <!-- Spacer for alignment -->
                <button id="speak-btn-B"
                        class="speak-button bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50"
                        aria-label="Speak Translation"
                        disabled>
                    Speak
                </button>
            </div>
        </div>

    </div>
    
    <p id="error-message" class="text-red-500 mt-4 text-center font-medium hidden">Microphone access denied or not supported.</p>

</div>

<script>
    // --- 1. Tooling and Constants Setup ---
    
    // UI Elements
    const textA = document.getElementById('text-A');
    const textB = document.getElementById('text-B');
    const titleA = document.getElementById('title-A');
    const titleB = document.getElementById('title-B');
    const micBtnA = document.getElementById('mic-btn-A');
    const speakBtnB = document.getElementById('speak-btn-B');
    const statusA = document.getElementById('status-A');
    const errorMessage = document.getElementById('error-message');
    const langSelect = document.getElementById('secondary-language-select');
    const swapBtn = document.getElementById('swap-btn');

    // Language Codes
    const PRIMARY_CODE = 'en-US'; 
    const PRIMARY_NAME = 'English';
    
    // State variables for the current direction
    let secondaryCode = langSelect.value;
    let secondaryName = langSelect.options[langSelect.selectedIndex].getAttribute('data-name');
    
    let currentSourceCode = PRIMARY_CODE;
    let currentTargetCode = secondaryCode;
    let currentSourceName = PRIMARY_NAME;
    let currentTargetName = secondaryName;

    // Speech Recognition and State
    let recognition = null;
    let isRecording = false;

    // --- 2. Core UI Update & State Management ---
    
    const updateUI = () => {
        // Update Panel A (Source)
        titleA.textContent = `${currentSourceName} (Source)`;
        textA.placeholder = `Speak in ${currentSourceName}, or type, to translate...`;
        micBtnA.setAttribute('aria-label', `Start Recording ${currentSourceName}`);

        // Update Panel B (Target)
        titleB.textContent = `${currentTargetName} (Target)`;
        textB.placeholder = `The ${currentTargetName} translation will appear here...`;
        speakBtnB.textContent = `Speak ${currentTargetName}`;
        speakBtnB.setAttribute('aria-label', `Speak Translation in ${currentTargetName}`);

        // Set the recognition language dynamically
        if (recognition) {
            recognition.lang = currentSourceCode;
        }

        // Clear and disable controls initially
        textA.value = '';
        textB.value = '';
        speakBtnB.disabled = true;
    };
    
    const swapLanguages = () => {
        // Swap the current codes and names
        [currentSourceCode, currentTargetCode] = [currentTargetCode, currentSourceCode];
        [currentSourceName, currentTargetName] = [currentTargetName, currentSourceName];
        
        // Update the UI to reflect the new direction
        updateUI();
    };

    const handleSecondaryLanguageChange = () => {
        secondaryCode = langSelect.value;
        secondaryName = langSelect.options[langSelect.selectedIndex].getAttribute('data-name');
        
        // If English is currently the source, set the new selection as the target
        if (currentSourceCode === PRIMARY_CODE) {
            currentTargetCode = secondaryCode;
            currentTargetName = secondaryName;
        } 
        // If the other language is currently the source, set the new selection as the source
        else {
            currentSourceCode = secondaryCode;
            currentSourceName = secondaryName;
        }
        
        updateUI();
    };

    // --- 3. Initialize Speech Recognition ---
    const initializeRecognition = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            errorMessage.textContent = "Speech Recognition is not supported in this browser. Please use Chrome or Edge.";
            errorMessage.classList.remove('hidden');
            micBtnA.disabled = true;
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentSourceCode; // Set initial language

        recognition.onstart = () => {
            isRecording = true;
            micBtnA.classList.add('recording');
            statusA.classList.remove('hidden');
            textA.value = '';
            textB.value = '';
            speakBtnB.disabled = true;
        };

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            
            textA.value = transcript;
            
            if (transcript) {
                // Call translation with current source/target codes
                translateAndDisplay(transcript, currentSourceCode, currentTargetCode, currentTargetName);
            }
        };

        recognition.onend = () => {
            isRecording = false;
            micBtnA.classList.remove('recording');
            statusA.classList.add('hidden');
        };

        recognition.onerror = (event) => {
            console.error('Speech Recognition Error:', event.error);
            errorMessage.textContent = `Microphone Error: ${event.error}. Please allow microphone access.`;
            errorMessage.classList.remove('hidden');
            micBtnA.classList.remove('recording');
            statusA.classList.add('hidden');
            isRecording = false;
        };
        
        micBtnA.disabled = false;
    };

    // --- 4. Translation Function (Uses Gemini API) ---
    const translateAndDisplay = async (text, sourceCode, targetCode, targetName) => {
        textB.placeholder = `Translating to ${targetName}...`;
        
        const sourceName = sourceCode === PRIMARY_CODE ? PRIMARY_NAME : targetName; // Simple way to derive name
        
        // Construct the dynamic system prompt and user query
        const systemPrompt = `You are a highly accurate, professional language translator. Your only job is to translate the provided text from ${sourceName} into a grammatically correct, natural-sounding ${targetName} translation. Respond with ONLY the translated ${targetName} text, nothing else.`;
        const userQuery = `Translate the following ${sourceName} phrase to ${targetName}: "${text}"`;
        
        // API Configuration (Your key should already be here)
        // >>> IMPORTANT: PASTE YOUR GEMINI API KEY HERE TO MAKE THE TRANSLATION WORK ON GITHUB PAGES <<<
        const apiKey = "AIzaSyBEQukhkVCX_4xed29ByJYxszIDn8IPNgM"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        if (!apiKey) {
            textB.value = "ERROR: API Key is missing. Please edit the code to include your Gemini API Key.";
            speakBtnB.disabled = true;
            console.error("API Key Missing.");
            return;
        }

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };
        
        let translatedText = "Translation failed or is unavailable.";
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorData.error?.message || 'Unknown API Error'}`);
            }
            
            const result = await response.json();
            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                translatedText = candidate.content.parts[0].text.trim(); 
            }
        } catch (error) {
            console.error("Translation API Request Failed:", error.message);
            translatedText = `Translation Error: ${error.message}`;
        }
        
        textB.value = translatedText;
        textB.placeholder = `The ${targetName} translation will appear here...`;
        
        // Enable speech button only if translation appears successful
        speakBtnB.disabled = translatedText.includes("Error") || translatedText.includes("unavailable");
    };

    // --- 5. Text-to-Speech (Speaking the Translation) ---
    const speakTranslation = () => {
        const textToSpeak = textB.value;
        if (!textToSpeak) return;

        if (!'speechSynthesis' in window) {
            errorMessage.textContent = "Text-to-Speech is not supported in this browser.";
            errorMessage.classList.remove('hidden');
            return;
        }
        
        // Use the current target code for the voice
        const targetCode = currentTargetCode; 
        
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        
        // Find a matching voice for the target language
        const voices = window.speechSynthesis.getVoices();
        const targetVoice = voices.find(voice => voice.lang === targetCode || voice.lang.startsWith(targetCode.substring(0, 2)));
        
        if (targetVoice) {
            utterance.voice = targetVoice;
        } else {
            utterance.lang = targetCode; 
            console.warn(`Voice for ${targetCode} not found, using default voice with correct language setting.`);
        }
        
        window.speechSynthesis.speak(utterance);
    };


    // --- 6. Event Listeners & Initialization ---
    
    // Voice Input Button (Always attached to Panel A)
    micBtnA.addEventListener('click', () => {
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    });
    
    // Text Input Detection (Allows translation when user types instead of speaking)
    let typingTimer;
    const doneTypingInterval = 1000; // 1 second
    
    textA.addEventListener('keyup', () => {
        clearTimeout(typingTimer);
        const text = textA.value.trim();
        if (text) {
            typingTimer = setTimeout(() => {
                translateAndDisplay(text, currentSourceCode, currentTargetCode, currentTargetName);
            }, doneTypingInterval);
        } else {
            textB.value = '';
            speakBtnB.disabled = true;
        }
    });
    
    // Speak Button (Always attached to Panel B)
    speakBtnB.addEventListener('click', speakTranslation);
    
    // Swap Button
    swapBtn.addEventListener('click', swapLanguages);

    // Secondary Language Selector
    langSelect.addEventListener('change', handleSecondaryLanguageChange);

    // Initial setup on page load
    window.onload = () => {
        handleSecondaryLanguageChange(); // Set initial state (English -> French)
        initializeRecognition();

        // Ensure voices are loaded for TTS
        if ('speechSynthesis' in window) {
            if (window.speechSynthesis.getVoices().length === 0) {
                 window.speechSynthesis.onvoiceschanged = initializeRecognition;
            }
        }
    };
</script>
</body>
</html>
